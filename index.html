<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Workflow Automation Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8fafc;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 0;
            margin-bottom: 30px;
            border-radius: 15px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }
        
        .auth-container {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            overflow: hidden;
            width: 100%;
            max-width: 400px;
            margin: 0 auto;
        }
        
        .auth-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .auth-content {
            padding: 40px;
        }
        
        .dashboard {
            display: none;
        }
        
        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }
        
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 10px;
            transition: all 0.3s;
            font-weight: 600;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .card h3 {
            margin-bottom: 15px;
            color: #333;
            font-size: 1.3rem;
        }
        
        .workflow-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .workflow-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border: 2px solid transparent;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .workflow-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0,0,0,0.15);
        }
        
        .workflow-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
        }
        
        .workflow-icon {
            font-size: 2rem;
            margin-bottom: 15px;
        }
        
        .workflow-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: #333;
        }
        
        .workflow-description {
            color: #666;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .workflow-status {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .integration-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .integration-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: all 0.3s;
        }
        
        .integration-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .integration-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        
        .integration-status {
            margin-top: 15px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .status-connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status-disconnected {
            background: #f8d7da;
            color: #721c24;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            text-decoration: none;
            display: inline-block;
            margin: 5px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .status-message {
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-weight: 600;
        }
        
        .status-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .hidden {
            display: none;
        }
        
        .toggle-form {
            text-align: center;
            margin-top: 20px;
        }
        
        .toggle-form a {
            color: #667eea;
            text-decoration: none;
            cursor: pointer;
        }
        
        .toggle-form a:hover {
            text-decoration: underline;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .database-selector {
            margin-top: 20px;
        }
        
        .database-option {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .database-option:hover {
            border-color: #667eea;
            background: #f8f9ff;
        }
        
        /* Analytics Styles */
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .analytics-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        
        .analytics-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .analytics-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .analytics-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .workflow-analytics {
            margin-top: 30px;
        }
        
        .workflow-analytics h4 {
            margin-bottom: 15px;
            color: #333;
        }
        
        .workflow-stat {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        
        .workflow-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }
        
        .workflow-metrics {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .metric {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            color: #666;
        }
        
        .metric.success {
            background: #d4edda;
            color: #155724;
        }
        
        .metric.failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .recent-activity {
            margin-top: 30px;
        }
        
        .recent-activity h4 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .activity-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border: 1px solid #e1e5e9;
            border-radius: 10px;
            margin-bottom: 10px;
            background: white;
        }
        
        .activity-icon {
            font-size: 1.5rem;
            margin-right: 15px;
        }
        
        .activity-details {
            flex: 1;
        }
        
        .activity-title {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .activity-meta {
            font-size: 0.9rem;
            color: #666;
        }
        
        /* Execution Card Styles */
        .execution-card {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .execution-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .execution-header h4 {
            margin: 0;
            color: #333;
        }
        
        .execution-status {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .execution-details {
            margin-bottom: 15px;
        }
        
        .execution-details p {
            margin: 5px 0;
            color: #666;
        }
        
        .execution-steps {
            border-top: 1px solid #e1e5e9;
            padding-top: 15px;
        }
        
        .execution-steps h5 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .step-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 5px;
        }
        
        .step-name {
            font-weight: 600;
            color: #333;
        }
        
        .step-status {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .step-success {
            background: #d4edda;
            color: #155724;
        }
        
        .step-failed {
            background: #f8d7da;
            color: #721c24;
        }
        
        .step-time {
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Logs Table Styles */
        .logs-table {
            overflow-x: auto;
        }
        
        .logs-table table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .logs-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
        }
        
        .logs-table td {
            padding: 12px 10px;
            border-bottom: 1px solid #e1e5e9;
        }
        
        .logs-table tr:hover {
            background: #f8f9ff;
        }
        
        .log-success {
            background: #f8fff8;
        }
        
        .log-error {
            background: #fff8f8;
        }
        
        .log-type {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .log-type.trigger {
            background: #e3f2fd;
            color: #1976d2;
        }
        
        .log-type.action {
            background: #f3e5f5;
            color: #7b1fa2;
        }
        
        .log-app {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            background: #e8f5e8;
            color: #2e7d32;
        }
        
        .database-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f8f9ff 0%, #f0f2ff 100%);
        }
        
        .database-info {
            flex: 1;
        }
        
        .database-title {
            font-weight: 600;
            color: #333;
        }
        
        .database-url {
            color: #666;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- Authentication Section -->
    <div id="auth-section">
        <div class="container">
            <div class="header">
                <h1>üöÄ Workflow Automation Platform</h1>
                <p>Automate your workflows with Google Calendar and Notion</p>
            </div>
            
            <div class="auth-container">
                <div class="auth-header">
                    <h2>Welcome Back</h2>
                    <p>Sign in to continue</p>
                </div>
                
                <div class="auth-content">
                    <!-- Login Form -->
                    <div id="login-form">
                        <h3 style="margin-bottom: 20px; color: #333;">Login</h3>
                        <div class="form-group">
                            <label for="login-email">Email:</label>
                            <input type="email" id="login-email" placeholder="Enter your email">
                        </div>
                        <div class="form-group">
                            <label for="login-password">Password:</label>
                            <input type="password" id="login-password" placeholder="Enter your password">
                        </div>
                        <button class="btn" onclick="login()" style="width: 100%;">Login</button>
                        <div class="toggle-form">
                            <a onclick="showSignup()">Don't have an account? Sign up</a>
                        </div>
                    </div>
                    
                    <!-- Signup Form -->
                    <div id="signup-form" class="hidden">
                        <h3 style="margin-bottom: 20px; color: #333;">Create Account</h3>
                        <div class="form-group">
                            <label for="signup-email">Email:</label>
                            <input type="email" id="signup-email" placeholder="Enter your email">
                        </div>
                        <div class="form-group">
                            <label for="signup-password">Password:</label>
                            <input type="password" id="signup-password" placeholder="Enter your password">
                        </div>
                        <div class="form-group">
                            <label for="signup-name">Name:</label>
                            <input type="text" id="signup-name" placeholder="Enter your name">
                        </div>
                        <button class="btn" onclick="signup()" style="width: 100%;">Sign Up</button>
                        <div class="toggle-form">
                            <a onclick="showLogin()">Already have an account? Login</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboard-section" class="dashboard">
        <div class="container">
            <div class="dashboard-header">
                <div class="user-info">
                    <div class="user-avatar" id="user-avatar"></div>
                    <div>
                        <h3 id="user-name">Welcome!</h3>
                        <p id="user-email"></p>
                    </div>
                </div>
                <button class="btn btn-secondary" onclick="logout()">Logout</button>
            </div>
            
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="showTab('workflows')">üìã Workflows</div>
                <div class="nav-tab" onclick="showTab('integrations')">üîó Integrations</div>
                <div class="nav-tab" onclick="showTab('logs')">üìã Logs</div>
            </div>
            
            <!-- Workflows Tab -->
            <div id="workflows-tab" class="tab-content active">
                <div class="card">
                    <h3>Available Workflows</h3>
                    <p>Select a workflow to configure and activate it with your integrations.</p>
                    <div id="workflows-grid" class="workflow-grid">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading workflows...
                        </div>
                    </div>
                </div>
                
                <div id="workflow-setup" class="card hidden">
                    <h3>Configure Workflow</h3>
                    <div id="workflow-setup-content">
                        <!-- Dynamic content will be loaded here -->
                    </div>
                </div>
            </div>
            
            <!-- Integrations Tab -->
            <div id="integrations-tab" class="tab-content">
                <div class="card">
                    <h3>Connected Services</h3>
                    <p>Connect your Google Calendar and Notion to enable workflow automation.</p>
                    <div id="integrations-grid" class="integration-grid">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading integrations...
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Logs Tab -->
            <div id="logs-tab" class="tab-content">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <div>
                            <h3>üìä Workflow Analytics</h3>
                            <p>Track your workflow performance and execution history.</p>
                        </div>
                        <button class="btn btn-small" onclick="loadLogs()">
                            üîÑ Refresh
                        </button>
                    </div>
                    <div id="analytics-container">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading analytics...
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <h3>üìã Execution Logs</h3>
                    <p>Detailed logs of all workflow activities.</p>
                    <div id="logs-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading logs...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://127.0.0.1:8000';
        let currentUser = null;
        let userToken = null;
        let selectedWorkflow = null;
        let userWorkflows = [];
        let userIntegrations = [];

        // Form toggle functions
        function showSignup() {
            document.getElementById('login-form').classList.add('hidden');
            document.getElementById('signup-form').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('signup-form').classList.add('hidden');
            document.getElementById('login-form').classList.remove('hidden');
        }

        // Tab navigation
        function showTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`${tabName}-tab`).classList.add('active');
            
            // Load tab data
            if (tabName === 'workflows') {
                loadWorkflows();
            } else if (tabName === 'integrations') {
                loadIntegrations();
            } else if (tabName === 'logs') {
                loadLogs();
            }
        }

        // Authentication functions
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            if (!email || !password) {
                showMessage('Please enter both email and password', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    userToken = data.access_token;
                    currentUser = data.user;
                    showDashboard();
                    showMessage('Login successful!', 'success');
                } else {
                    const errorData = await response.json();
                    showMessage('Login failed: ' + (errorData.detail || 'Invalid credentials'), 'error');
                }
            } catch (error) {
                showMessage('Login failed: ' + error.message, 'error');
            }
        }

        async function signup() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const name = document.getElementById('signup-name').value;
            
            if (!email || !password || !name) {
                showMessage('Please fill in all fields', 'error');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/auth/signup`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password,
                        name: name
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    userToken = data.access_token;
                    currentUser = data.user;
                    showDashboard();
                    showMessage('Account created successfully!', 'success');
                } else {
                    const errorData = await response.json();
                    showMessage('Signup failed: ' + (errorData.detail || 'Please try again'), 'error');
                }
            } catch (error) {
                showMessage('Signup failed: ' + error.message, 'error');
            }
        }

        function logout() {
            currentUser = null;
            userToken = null;
            showAuth();
            showMessage('Logged out successfully', 'success');
        }

        function showAuth() {
            document.getElementById('auth-section').style.display = 'block';
            document.getElementById('dashboard-section').style.display = 'none';
        }

        function showDashboard() {
            document.getElementById('auth-section').style.display = 'none';
            document.getElementById('dashboard-section').style.display = 'block';
            
            // Update user info
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-email').textContent = currentUser.email;
            document.getElementById('user-avatar').textContent = currentUser.name.charAt(0).toUpperCase();
            
            // Load initial data
            loadWorkflows();
            loadIntegrations();
        }

        // Workflow functions
        async function loadWorkflows() {
            try {
                const response = await fetch(`${API_BASE}/workflows/list`, {
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                if (response.ok) {
                    const workflows = await response.json();
                    
                    // Get user's active workflows
                    const activeResponse = await fetch(`${API_BASE}/workflows/user/active`, {
                        headers: {
                            'Authorization': `Bearer ${userToken}`
                        }
                    });
                    
                    let activeWorkflows = [];
                    if (activeResponse.ok) {
                        activeWorkflows = await activeResponse.json();
                    }
                    
                    // Add descriptions and icons to workflows
                    const workflowDescriptions = {
                        1: {
                            name: "Notion to Google Meet",
                            description: "Automatically create Google Meet events from Notion database entries",
                            icon: "üìÖ"
                        },

                        3: {
                            name: "Google Meet to Notion",
                            description: "Create Notion entries from Google Meet events",
                            icon: "üé•"
                        }
                    };
                    
                    // Format workflows for display
                    userWorkflows = workflows.map(workflow => {
                        const desc = workflowDescriptions[workflow.id] || {
                            name: workflow.name,
                            description: "Workflow automation",
                            icon: "‚öôÔ∏è"
                        };
                        
                        const isActive = activeWorkflows.some(aw => aw.workflow_id === workflow.id);
                        
                        return {
                            ...workflow,
                            name: desc.name,
                            description: desc.description,
                            icon: desc.icon,
                            is_active: isActive
                        };
                    });
                    
                    displayWorkflows();
                } else {
                    showMessage('Failed to load workflows', 'error');
                }
            } catch (error) {
                showMessage('Failed to load workflows: ' + error.message, 'error');
            }
        }

        function displayWorkflows() {
            const grid = document.getElementById('workflows-grid');
            grid.innerHTML = '';
            
            userWorkflows.forEach(workflow => {
                const card = document.createElement('div');
                card.className = 'workflow-card';
                card.onclick = () => selectWorkflow(workflow);
                
                const status = workflow.is_active ? 'Active' : 'Inactive';
                const statusClass = workflow.is_active ? 'status-active' : 'status-inactive';
                
                card.innerHTML = `
                    <div class="workflow-icon">${workflow.icon || '‚öôÔ∏è'}</div>
                    <div class="workflow-title">${workflow.name}</div>
                    <div class="workflow-description">${workflow.description}</div>
                    <div class="workflow-status ${statusClass}">${status}</div>
                `;
                
                grid.appendChild(card);
            });
        }

        function selectWorkflow(workflow) {
            selectedWorkflow = workflow;
            
            // Update UI
            document.querySelectorAll('.workflow-card').forEach(card => card.classList.remove('selected'));
            event.currentTarget.classList.add('selected');
            
            // Show setup section
            document.getElementById('workflow-setup').classList.remove('hidden');
            
            // Load setup content
            loadWorkflowSetup(workflow);
        }

        async function loadWorkflowSetup(workflow) {
            const setupContent = document.getElementById('workflow-setup-content');
            
            setupContent.innerHTML = `
                <h4>${workflow.name}</h4>
                <p>${workflow.description}</p>
                
                <div style="margin: 20px 0;">
                    <h5>Required Integrations:</h5>
                    <ul>
                        <li>Google Calendar - for reading calendar events</li>
                        <li>Notion - for creating database entries</li>
                    </ul>
                </div>
                
                <div style="margin: 20px 0;">
                    <button class="btn" onclick="connectGoogle()">üîó Connect Google Calendar</button>
                    <button class="btn" onclick="connectNotion()">üìù Connect Notion</button>
                </div>
                
                <div style="margin: 20px 0;">
                    <button class="btn btn-success" onclick="activateWorkflow()" ${workflow.is_active ? 'disabled' : ''}>
                        ${workflow.is_active ? '‚úÖ Active' : '‚ñ∂Ô∏è Activate Workflow'}
                    </button>
                    <button class="btn btn-danger" onclick="deactivateWorkflow()" ${!workflow.is_active ? 'disabled' : ''}>
                        ${workflow.is_active ? '‚è∏Ô∏è Deactivate' : 'Inactive'}
                    </button>
                </div>
                
                <div style="margin: 20px 0;">
                    <button class="btn btn-secondary" onclick="testWorkflow()">üß™ Test Workflow</button>
                </div>
            `;
        }

        // Integration functions
        async function loadIntegrations() {
            try {
                const response = await fetch(`${API_BASE}/auth/integrations?user_id=${currentUser.id}`, {
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    userIntegrations = data.integrations || [];
                    displayIntegrations();
                } else {
                    showMessage('Failed to load integrations', 'error');
                }
            } catch (error) {
                showMessage('Failed to load integrations: ' + error.message, 'error');
            }
        }

        function displayIntegrations() {
            const grid = document.getElementById('integrations-grid');
            grid.innerHTML = '';
            
            const integrations = [
                {
                    name: 'Google Calendar',
                    icon: 'üìÖ',
                    provider: 'google',
                    description: 'Connect your Google Calendar to read events'
                },
                {
                    name: 'Notion',
                    icon: 'üìù',
                    provider: 'notion',
                    description: 'Connect your Notion workspace to create entries'
                }
            ];
            
            integrations.forEach(integration => {
                const userIntegration = userIntegrations.find(ui => ui.provider === integration.provider);
                const isConnected = !!userIntegration;
                const statusClass = isConnected ? 'status-connected' : 'status-disconnected';
                const statusText = isConnected ? 'Connected' : 'Not Connected';
                
                const card = document.createElement('div');
                card.className = 'integration-card';
                
                card.innerHTML = `
                    <div class="integration-icon">${integration.icon}</div>
                    <h4>${integration.name}</h4>
                    <p>${integration.description}</p>
                    <div class="integration-status ${statusClass}">${statusText}</div>
                    <div style="margin-top: 15px;">
                        ${isConnected ? 
                            `<button class="btn btn-small btn-secondary" onclick="disconnectIntegration('${integration.provider}')">Disconnect</button>` :
                            `<button class="btn btn-small" onclick="connectIntegration('${integration.provider}')">Connect</button>`
                        }
                    </div>
                `;
                
                grid.appendChild(card);
            });
        }

        function connectIntegration(provider) {
            if (provider === 'google') {
                connectGoogle();
            } else if (provider === 'notion') {
                connectNotion();
            }
        }

        function connectGoogle() {
            window.open(`${API_BASE}/auth/google/connect?user_id=${currentUser.id}`, '_blank');
            showMessage('Opening Google OAuth... Please complete the authorization and return here.', 'info');
        }

        function connectNotion() {
            // Show database selection dialog
            showNotionDatabaseDialog();
        }

        function showNotionDatabaseDialog() {
            const setupContent = document.getElementById('workflow-setup-content');
            setupContent.innerHTML = `
                <h4>Connect Notion</h4>
                <p>Choose how you want to connect Notion:</p>
                
                <div style="margin: 20px 0;">
                    <div class="form-group">
                        <label>Option 1: Connect and browse databases</label>
                        <button class="btn" onclick="connectNotionAndBrowse()">üîç Connect & Browse</button>
                    </div>
                    
                    <div class="form-group">
                        <label>Option 2: Connect with specific database ID</label>
                        <input type="text" id="notion-database-id" placeholder="Enter your Notion database ID">
                        <button class="btn" onclick="connectNotionWithDatabase()">üîó Connect with Database</button>
                    </div>
                </div>
                
                <div class="database-selector" id="database-selector" style="display: none;">
                    <h5>Select a Database:</h5>
                    <div id="database-list">
                        <div class="loading">
                            <div class="spinner"></div>
                            Loading databases...
                        </div>
                    </div>
                </div>
            `;
        }

        async function connectNotionAndBrowse() {
            window.open(`${API_BASE}/auth/notion/connect-and-select?user_id=${currentUser.id}`, '_blank');
            showMessage('Opening Notion OAuth... Please complete the authorization and return here.', 'info');
            
            // After a delay, show database selector
            setTimeout(() => {
                document.getElementById('database-selector').style.display = 'block';
                loadNotionDatabases();
            }, 3000);
        }

        async function connectNotionWithDatabase() {
            const databaseId = document.getElementById('notion-database-id').value;
            if (!databaseId) {
                showMessage('Please enter a database ID', 'error');
                return;
            }
            
            window.open(`${API_BASE}/auth/notion/connect-with-database?user_id=${currentUser.id}&database_id=${databaseId}`, '_blank');
            showMessage('Opening Notion OAuth with database... Please complete the authorization and return here.', 'info');
        }

        async function loadNotionDatabases() {
            try {
                const response = await fetch(`${API_BASE}/auth/notion/list-databases?user_id=${currentUser.id}`, {
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displayNotionDatabases(data.databases);
                } else {
                    showMessage('Failed to load databases', 'error');
                }
            } catch (error) {
                showMessage('Failed to load databases: ' + error.message, 'error');
            }
        }

        function displayNotionDatabases(databases) {
            const list = document.getElementById('database-list');
            list.innerHTML = '';
            
            databases.forEach(db => {
                const option = document.createElement('div');
                option.className = 'database-option';
                option.onclick = () => selectNotionDatabase(db.id);
                
                option.innerHTML = `
                    <div class="database-info">
                        <div class="database-title">${db.title}</div>
                        <div class="database-url">${db.url}</div>
                    </div>
                    <button class="btn btn-small">Select</button>
                `;
                
                list.appendChild(option);
            });
        }

        async function selectNotionDatabase(databaseId) {
            try {
                const response = await fetch(`${API_BASE}/auth/notion/select-database-after-oauth?user_id=${currentUser.id}&database_id=${databaseId}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                if (response.ok) {
                    showMessage('Notion database selected successfully!', 'success');
                    loadIntegrations(); // Refresh integrations
                    loadWorkflowSetup(selectedWorkflow); // Return to workflow setup
                } else {
                    showMessage('Failed to select database', 'error');
                }
            } catch (error) {
                showMessage('Failed to select database: ' + error.message, 'error');
            }
        }

                // Workflow management functions
        async function activateWorkflow() {
            if (!selectedWorkflow) return;
            
            try {
                const response = await fetch(`${API_BASE}/workflows/activate/${selectedWorkflow.id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                if (response.ok) {
                    showMessage('Workflow activated successfully!', 'success');
                    loadWorkflows(); // Refresh workflows
                } else {
                    const errorData = await response.json();
                    showMessage('Failed to activate workflow: ' + (errorData.detail || 'Unknown error'), 'error');
                }
            } catch (error) {
                showMessage('Failed to activate workflow: ' + error.message, 'error');
            }
        }

        async function deactivateWorkflow() {
            if (!selectedWorkflow) return;
            
            try {
                const response = await fetch(`${API_BASE}/workflows/deactivate/${selectedWorkflow.id}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                if (response.ok) {
                    showMessage('Workflow deactivated successfully!', 'success');
                    loadWorkflows(); // Refresh workflows
                } else {
                    showMessage('Failed to deactivate workflow', 'error');
                }
            } catch (error) {
                showMessage('Failed to deactivate workflow: ' + error.message, 'error');
            }
        }

        async function testWorkflow() {
            if (!selectedWorkflow) return;
            
            try {
                const response = await fetch(`${API_BASE}/workflows/${selectedWorkflow.id}/start`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showMessage(`Workflow executed successfully! ${data.message || ''}`, 'success');
                } else {
                    showMessage('Failed to execute workflow', 'error');
                }
            } catch (error) {
                showMessage('Failed to execute workflow: ' + error.message, 'error');
            }
        }

        // Logs functions
        async function loadLogs() {
            try {
                const response = await fetch(`${API_BASE}/workflows/logs`, {
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                if (response.ok) {
                    const logs = await response.json();
                    displayLogs(logs);
                    await displayAnalytics(logs);
                } else {
                    showMessage('Failed to load logs', 'error');
                }
            } catch (error) {
                showMessage('Failed to load logs: ' + error.message, 'error');
            }
        }

        async function displayAnalytics(logs) {
            const analyticsContainer = document.getElementById('analytics-container');
            if (!analyticsContainer) return;

            try {
                // Get analytics from API
                const response = await fetch(`${API_BASE}/workflows/analytics`, {
                    headers: {
                        'Authorization': `Bearer ${userToken}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error('Failed to fetch analytics');
                }
                
                const analytics = await response.json();
                
                // Calculate analytics
                const totalLogs = logs.length;
                const successfulLogs = logs.filter(log => log.success).length;
                const successRate = totalLogs > 0 ? Math.round((successfulLogs / totalLogs) * 100) : 0;
                
                // Count workflow executions
                const workflowExecutions = logs.filter(log => 
                    log.step_type === 'execution' && log.app === 'workflow'
                ).length;

                analyticsContainer.innerHTML = `
                    <div class="analytics-grid">
                        <div class="analytics-card">
                            <div class="analytics-icon">üìä</div>
                            <div class="analytics-number">${totalLogs}</div>
                            <div class="analytics-label">Total Actions</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon">‚úÖ</div>
                            <div class="analytics-number">${successfulLogs}</div>
                            <div class="analytics-label">Successful</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon">üìà</div>
                            <div class="analytics-number">${successRate}%</div>
                            <div class="analytics-label">Success Rate</div>
                        </div>
                        <div class="analytics-card">
                            <div class="analytics-icon">‚ö°</div>
                            <div class="analytics-number">${workflowExecutions}</div>
                            <div class="analytics-label">Workflow Runs</div>
                        </div>
                    </div>
                    
                    <div class="workflow-analytics">
                        <h4>Workflow Performance</h4>
                        ${Object.keys(analytics.workflows).length > 0 ? 
                            Object.entries(analytics.workflows).map(([workflowId, stats]) => `
                                <div class="workflow-stat">
                                    <div class="workflow-name">Workflow ${workflowId}</div>
                                    <div class="workflow-metrics">
                                        <span class="metric">${stats.executions} runs</span>
                                        <span class="metric success">${stats.successful} successful</span>
                                        <span class="metric failed">${stats.failed} failed</span>
                                        ${stats.last_execution ? 
                                            `<span class="metric">Last: ${new Date(stats.last_execution).toLocaleDateString()}</span>` : 
                                            ''
                                        }
                                    </div>
                                </div>
                            `).join('') : 
                            '<p>No workflow executions yet</p>'
                        }
                    </div>
                    
                    <div class="recent-activity">
                        <h4>Recent Activity</h4>
                        ${analytics.recent_activity.length > 0 ? 
                            analytics.recent_activity.map(log => `
                                <div class="activity-item">
                                    <div class="activity-icon">${log.success ? '‚úÖ' : '‚ùå'}</div>
                                    <div class="activity-details">
                                        <div class="activity-title">${log.description}</div>
                                        <div class="activity-meta">
                                            ${log.app} ‚Ä¢ ${log.step_type} ‚Ä¢ ${new Date(log.created_at).toLocaleDateString()}
                                        </div>
                                    </div>
                                </div>
                            `).join('') : 
                            '<p>No recent activity</p>'
                        }
                    </div>
                `;
            } catch (error) {
                console.error('Error fetching analytics:', error);
                analyticsContainer.innerHTML = '<p>Failed to load analytics</p>';
            }
        }

        function displayLogs(logs) {
            const list = document.getElementById('logs-list');
            
            if (logs.length === 0) {
                list.innerHTML = '<p>No logs found.</p>';
                return;
            }
            
            list.innerHTML = `
                <div class="logs-table">
                    <table>
                        <thead>
                            <tr>
                                <th>Time</th>
                                <th>Type</th>
                                <th>App</th>
                                <th>Description</th>
                                <th>Status</th>
                                <th>Error</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${logs.map(log => `
                                <tr class="${log.success ? 'log-success' : 'log-error'}">
                                    <td>${new Date(log.created_at).toLocaleString()}</td>
                                    <td><span class="log-type ${log.step_type}">${log.step_type}</span></td>
                                    <td><span class="log-app">${log.app}</span></td>
                                    <td>${log.description}</td>
                                    <td>${log.success ? '‚úÖ Done' : '‚ùå Fail'}</td>
                                    <td>${log.error || ''}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function showMessage(message, type) {
            // Remove existing messages
            const existingMessages = document.querySelectorAll('.status-message');
            existingMessages.forEach(msg => msg.remove());
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `status-message status-${type}`;
            messageDiv.textContent = message;
            
            // Add to dashboard if visible, otherwise to auth
            const target = document.getElementById('dashboard-section').style.display !== 'none' ? 
                document.querySelector('.container') : document.querySelector('.auth-content');
            
            target.insertBefore(messageDiv, target.firstChild);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 5000);
        }

        // Enter key support
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                if (!document.getElementById('login-form').classList.contains('hidden')) {
                    login();
                } else if (!document.getElementById('signup-form').classList.contains('hidden')) {
                    signup();
                }
            }
        });

        // Check for OAuth callback parameters
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('oauth_success')) {
            showMessage('OAuth connection successful! Please refresh the page.', 'success');
        }
    </script>
</body>
</html> 